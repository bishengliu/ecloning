
@{
    ViewBag.Title = "Sequence Editor";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var Type = ViewBag.Type;
}
@if(Type !="RNA" && Type != "DNA")
{
    <div class="col-xs-12 col-sm-offset-1 col-sm-10">
        <h3 class="text-danger text-center">Only RNA or DNA sequences are allowed!</h3>
    </div>
}
else
{
    <div class="row">
        <div class="row">
            <div class="col-xs-12 col-sm-offset-1 col-sm-10">
                <div class="col-xs-offset-1 col-xs-7 col-sm-offset-0 col-sm-6 col-md-offset-0 col-md-6 col-lg-offset-0 col-lg-4">
                    <h3 class="text-warning">@Type Sequence Editor</h3>
                </div>
                <div class="col-xs-3 col-sm-6 col-md-6 col-lg-8 hidden" id="finish-button">
                    <div class="pull-left">
                        <br />
                        <button type="button" class="btn btn-block btn-danger" id="finish">Finish</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    //hidden
    <p class="hidden" id="type">@Type</p>

    //capture seq
    <div class="row"  id="capture_seq">
        <div class="col-xs-12 col-sm-offset-1 col-sm-10">
            <p class="text-danger" id="msg"></p>
            @using (Html.BeginForm())
                {
                <div class="form-horizontal">
                        <div class="form-group required">
                            <div class="pull-left">
                                @Html.Label("Paste the Sequence", htmlAttributes: new { @class = "control-label col-md-12 text-primary" })
                            </div>
                            <p id="error" class="text-danger text-center"></p>
                            <div class="col-md-12">
                                <textarea id="seq" cols="10" rows="10" class="form-control"></textarea>
                            </div>
                        </div>
                    <div class="form-group">
                        <div class="col-sm-offset-5 col-sm-2">
                            <input type="submit" value="Edit Sequence" class="btn btn-block btn-primary" id="showEditor" />
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <br/>
    //show editor
    <div class="row hidden" id="editor">
        <div class="row">
            <div class="col-xs-12 col-sm-offset-1 col-sm-10">
                <div class="col-xs-12">
                    <form class="form-horizontal">
                        <div class="col-xs-6 col-sm-3 col-md-2 col-lg-2" style="display: inline-block">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="fa fa-trash-o text-danger"></i></span>
                                    <span class="input-group-addon">From</span>
                                    <input type="text" class="form-control" id="from_pos" placeholder="Position">
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-6 col-sm-3 col-md-2 col-lg-2" style="display: inline-block">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon">To</span>
                                    <input type="text" class="form-control" id="to_pos" placeholder="Position">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="button" id="delete_seq">
                                            <i class="fa fa-check"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="col-xs-offset-1">
                    <p class="text-danger" id="delete_msg"></p>
                </div>
            </div>
            <div class="col-xs-12 col-sm-offset-1 col-sm-10">
                <div class="col-xs-12">
                    <form class="form-horizontal">
                        <div class="col-xs-6 col-sm-2 col-md-1 col-lg-1" style="display: inline-block">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="fa fa-plus text-danger"></i></span>
                                    <select class="form-control" id="aob">
                                        <option>After</option>
                                        <option>Before</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-6 col-sm-2 col-md-1 col-lg-1" style="display: inline-block">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="insert_pos" placeholder="Position">
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4" style="display: inline-block">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="insert_seq" placeholder="Sequence">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="button" id="insert">
                                            <i class="fa fa-check"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="col-xs-offset-1">
                    <p class="text-danger" id="insert_msg"></p>
                </div>
            </div>
            <span id="decodeIt" class="hidden"></span>
            <span id="seq" class="hidden"></span>            
        </div>
    </div>
    <div class="col-xs-12 col-sm-offset-1 col-sm-10">
        <div id="seq-editor">

        </div>
    </div>
    <br/>
    //new seq
    <div class="row hidden" id="result_seq">
        <div class="col-xs-12 col-sm-offset-1 col-sm-10">
            @using (Html.BeginForm())
                {
                <div class="form-horizontal">
                    <div class="form-group">
                        <div class="pull-left">
                            @Html.Label("New Sequence", htmlAttributes: new { @class = "control-label col-md-12 text-primary" })
                        </div>
                        <div class="col-md-12">
                            <textarea id="new_seq" cols="10" rows="10" class="form-control" readonly></textarea>
                        </div>
                    </div>
                </div>
                }
        </div>
    </div>
}
@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/d3")
<script src="~/Scripts/ecloning-seqeditor.js"></script>
<script>
    //empty object to store user editing info, will be updated later
    //remove all non letter in the seqeuce input
    var EditObj = [];
    var seqObj = [];
    //get the type
    var type = $("#type").text().trim();
    $('#seq').change(function () {
            var type = $("#type").text().trim();
            var before = $('#seq').val();
            //strip out non-alpha characters and convert to uppercase
            var after = before.replace(/[^a-zA-Z]+|\s+$|[0-9]+/g, '').toUpperCase();
            if (type == "DNA") {
                after = after.replace(/[bdefhijklmnopqrsuvwxyzBDEFHIJKLMNOPQRSUVWZYX]+|\s+$|[0-9]+/g, '').toUpperCase();
            }
            else {
                //RNA
                after = after.replace(/[bdefhijklmnopqrstvwxyzBDEFHIJKLMNOPQRSTVWZYX]+|\s+$|[0-9]+/g, '').toUpperCase();
            }
            $('#seq').val(after);
        });
    //capture seq and show editor
    $("#showEditor").on("click", function (e) {
            e.preventDefault();
            if (validateForm()) {
                var seq = $('#seq').val().toUpperCase();
                //show the editor and hide form
                if (!$("#capture_seq").hasClass("hidden")) {
                    $("#capture_seq").addClass("hidden");
                }
                //prepare the editor
                seqEditor(seq, "#seq-editor", type);
                if ($("#editor").hasClass("hidden")) {
                    $("#editor").removeClass("hidden");
                }
                //show the finish button
                if ($("#finish-button").hasClass("hidden")) {
                    $("#finish-button").removeClass("hidden");
                }
            }
            else {
                console.log('form validation failed!');
            }
    });
    //when click finish button
    $("#finish-button").on("click", function (e) {
        //hide finish button
        if (!$("#finish-button").hasClass("hidden")) {
            $("#finish-button").addClass("hidden");
        }
        //hide the editor
        if (!$("#editor").hasClass("hidden")) {
            $("#editor").addClass("hidden");
        }
        //remove the editor-seq
        $("#seq-editor").empty();
        //generate the final seq
        $("#msg").text(null);
        //check whether user edit or not
        if (EditObj.length == 0) {
            $("#new_seq").val("You haven't edited anything!");
        }
        else {
            //generate final seq array
            var seq = $('#seq').val().trim();
            var seqArray = seq.split('');
            var finalSeqArray = genFinalSeq(seqArray, EditObj);
            //final seq
            var finalSeq = finalSeqArray.join('');
            $("#new_seq").val(finalSeq);
        }
        if ($("#result_seq").hasClass("hidden")) {
            $("#result_seq").removeClass("hidden");
        }
    });
</script>
