@{
    ViewBag.Title = "Bundle Replacer";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var bundleObj = ViewBag.BundleSeq;
}

<div class="row">
    <div class="col-xs-12 col-sm-offset-1 col-sm-10">
        <h3 class="text-warning text-center">Sequence Replacer</h3>
    </div>
</div>

<span id="decodeIt" class="hidden"></span>
<div class="alert alert-info alert-dismissible fade in col-xs-12 col-sm-offset-1 col-sm-10" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
    <strong>Howto: </strong>
    <br/>1) The replacer only accepts <span><em>single-stranded</em></span> DNA sequences. All letters or symbols except "a/A", "t/T", "g/G" and "c/C", such as space, line break, number, nonprintable characters <i>etc.</i> will be removed automatically;
    <br/>2) You first need to provide the DNA sequence to be replaced. This DNA sequence must NOT be shorter than <strong class="text-danger">10</strong> letters. The replacer uses the "Exact Match" to find the sequence to be replaced on all the plasmids in the current bundle;
    <br/>3) After that, you will be asked to provide the new DNA sequence that will replace the sequence in the previous step. if you don't provide this sequence, the replacer will remove the DNA sequence provied in the previous step.
    <br/>4) The replacer will ask you to choose what to replace if <strong class="text-danger"><=3</strong> matches are found on a plasmid. If too much matches (>4) found, the plasmid will be ingnored; Increase the length of the DNA sequence to be replaced will reduces the number of matches.
</div>

<div class="row" id="tobereplaced">
    <div class="col-xs-12 col-sm-offset-1 col-sm-10">
        <div class="panel panel-primary" id="old_panel">
            <div class="panel-heading">
                <strong class="text-warning">Step 1</strong>: Provide below the single-stranded DNA sequence to be replaced
            </div>
            <div class="panel-body">
                <p class="text-info">The DNA sequence must NOT be shorter than <strong class="text-danger">10</strong> letters. &nbsp;<span class="text-danger" id="old_msg"></span></p>
                <textarea class="form-control" id="old_dna" rows="5"></textarea>
            </div>
            <div class="panel-footer clearfix">
                <button class="btn btn-default pull-right disabled" id="old_button">
                    <i class="fa fa-chevron-circle-right"></i>
                    <span>Next</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row hidden" id="new_seq_div">
    <div class="col-xs-12 col-sm-offset-1 col-sm-10">
        <div class="panel panel-primary" id="new_panel">
            <div class="panel-heading">
                <strong class="text-warning">Step 2</strong>: Provide below the single-stranded DNA sequence that will replace the sequence provided in step 1.
            </div>
            <div class="panel-body">
                <p class="text-info">if you don't provide the new DNA sequence, the replacer will remove the DNA sequence provied in step 1.<br /><span class="text-danger" id="new_msg"></span></p>
                <textarea class="form-control" id="new_dna" rows="5"></textarea>
            </div>
            <div class="panel-footer clearfix">
                <button class="btn btn-danger pull-right" id="new_button">
                    <i class="fa fa-chevron-circle-right"></i>
                    <span>Next</span>
                </button>
            </div>
        </div>
    </div>
</div>



<div class="row hidden" id="match_found">
    <div class="col-xs-12 col-sm-offset-1 col-sm-10">
        <div class="panel panel-primary">
            <div class="panel-heading">Matches Overview</div>
            <div class="panel-body">
                <div id="aligment"></div>
                <div id="match_overview"></div>
            </div>
            <div class="panel-footer clearfix">
                <button class="btn btn-default pull-right disabled" id="match_button">
                    <i class="fa fa-chevron-circle-right"></i>
                    <span>Next</span>
                </button>
            </div>
        </div>
    </div>
</div>



@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/giraffe")
<script src="~/Scripts/msa/msa.min.gz.js"></script>
<script src="~/Scripts/needleman-Wunsch.js"></script>
@*cust funcitons*@
<script src="~/Scripts/ecloning-ali2seq.js"></script>
<script>
    //define array to hold the matches
    /*
    obj = {
        "pId": 1,
        "show": false,
        "seqCount": 1000, //total seq count of  a plasmid
        "match": [startPos1, startPos2, startPos2] //1 based index of the start positions of the matches
    }
    */
    var mathes = [];



    $(document).ready(function () {
        //get plasmid ids
        var bundleObj = ("@bundleObj");
        document.getElementById("decodeIt").innerHTML = bundleObj;
        bundleObj = document.getElementById("decodeIt").innerText;


        try
        {
            bundleObj = JSON.parse(bundleObj);
            console.log(bundleObj);

            //===================old seq===============================
            //remove all non letter in the seqeuce input
            $('#old_dna').change(function () {
                var before = $('#old_dna').val();
                //strip out non-alpha characters and convert to uppercase
                var after = before.replace(/[^a-zA-Z]+|\s+$|[0-9]+/g, '').toUpperCase();
                after = after.replace(/[bdefhijklmnopqrsuvwxyzBDEFHIJKLMNOPQRSUVWZYX]+|\s+$|[0-9]+/g, '').toUpperCase();
                $('#old_dna').val(after);
                var count = after.length;
                if (count < 10) {
                    $("#old_msg").text("Please provide a DNA sequence no shorter than 10 letters!");

                    if ($("#old_button").hasClass("btn-danger")) {
                        $("#old_button").removeClass("btn-danger");
                    }
                    if (!$("#old_button").hasClass("btn-default")) {
                        $("#old_button").addClass("btn-default");
                    }
                    if (!$("#old_button").hasClass("disabled")) {
                        $("#old_button").addClass("disabled");
                    }
                }
                else {
                    $("#old_msg").text(null);
                    if ($("#old_button").hasClass("btn-default")) {
                        $("#old_button").removeClass("btn-default");
                    }
                    if (!$("#old_button").hasClass("btn-danger")) {
                        $("#old_button").addClass("btn-danger");
                    }
                    if ($("#old_button").hasClass("disabled")) {
                        $("#old_button").removeClass("disabled");
                    }
                }
            });

            $("#old_button").on("click", function () {
                $("#old_dna").prop("readonly", true);
                //change the panel class
                if ($("#old_panel").hasClass("panel-primary")) {
                    $("#old_panel").removeClass("panel-primary");
                    $("#old_panel").addClass("panel-default");
                }
                if (!$("#old_button").hasClass("disabled")) {
                    $("#old_button").addClass("disabled");
                }

                //show the new seq div
                if ($("#new_seq_div").hasClass("hidden")) {
                    $("#new_seq_div").removeClass("hidden");
                }
                scrollTo("#new_seq_div");
            })


            //===================new seq===============================
            //remove all non letter in the seqeuce input
            $('#new_dna').change(function () {
                var before = $('#new_dna').val();
                //strip out non-alpha characters and convert to uppercase
                var after = before.replace(/[^a-zA-Z]+|\s+$|[0-9]+/g, '').toUpperCase();
                after = after.replace(/[bdefhijklmnopqrsuvwxyzBDEFHIJKLMNOPQRSUVWZYX]+|\s+$|[0-9]+/g, '').toUpperCase();
                $('#new_dna').val(after);
            });

            $("#new_button").on("click", function () {
                $("#new_dna").prop("readonly", true);
                //check the new seq
                if ($("#new_dna").length == 0) {
                    $("#new_msg").text("You did not provide the new sequence. The replacer will remove the DNA sequence provided in step 1 in all matched plasmids of the current bundle.");
                }
                else {
                    $("#new_msg").text(null);
                }
                if (!$("#new_button").hasClass("disabled")) {
                    $("#new_button").addClass("disabled");
                }
                //change the panel class
                if ($("#new_panel").hasClass("panel-primary")) {
                    $("#new_panel").removeClass("panel-primary");
                    $("#new_panel").addClass("panel-default");
                }
                //show the match div
                if ($("#match_found").hasClass("hidden")) {
                    $("#match_found").removeClass("hidden");
                }
                scrollTo("#match_found");



                //show the aligment if the new seq is provide
                if ($("#new_dna").length > 0) {
                    var seq1 = $("#old_dna").val().trim();
                    var seq2 = $("#new_dna").val().trim();
                    var seq1Name = "Step 1";
                    var seq2Name = "Step 2";

                    //align the seq and show the result
                    ali2seq(seq1, seq2, seq1Name, seq2Name, "aligment", "zappo");
                }

                //find matches

                //show match overview of all plasmids, non-match plasmids or >4 matches are not shown


            })

            //=====================match results=======================
            //show the aligmentd

        }
        catch (e) {
            console.log(e);
        }
    });
    
</script>





<script>
    function scrollTo(id) {
        $('html, body').animate({
            scrollTop: $(id).offset().top
        }, 1000);
    }
</script>