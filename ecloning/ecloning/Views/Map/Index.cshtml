@model IEnumerable<ecloning.Models.plasmid_map>

@{
    ViewBag.Title = "Plasmid Map";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string Name = (string)ViewBag.Name;
    int plasmidId = (int)ViewBag.Id;
    string Sequence = (string)ViewBag.Sequence;
    int seqCount = (int)ViewBag.SeqLength;
    var features = ViewBag.Features;
    var BackupCount = (int)ViewBag.BackupCount;
    var Tag = (string)ViewBag.Tag;
    var Plasmid = (ecloning.Models.plasmid)ViewBag.Plasmid;
}

<div class="row">
    <div class="hidden-sm hidden-xs col-md-0 col-lg-3">
        &nbsp;
    </div>
    <div class="col-xs-12 col-sm-6 col-sm-offset-4 col-md-offset-4 col-md-5 col-lg-offset-0 col-lg-5">
        <h3 class="text-warning text-center">
            Plasmid <em>@Name</em> Map(@seqCount bp)&nbsp;
            @if (Tag != "groupDispaly")
            {
                if (Model.Count() > 0 && Model.FirstOrDefault().locked == 1)
                {
                    <a class="btn btn-md btn-link" href="@Url.Action("unLock", "Map", new { plasmid_id = plasmidId, tag = Tag })">
                        <i class="fa fa-lock fa-2x pull-left text-danger"></i>
                    </a>
                }
                else
                {
                    <a class="btn btn-md btn-link" href="@Url.Action("Lock", "Map", new { plasmid_id = plasmidId, tag = Tag})">
                        <i class="fa fa-unlock fa-2x pull-left text-danger"></i>
                    </a>
                }
            }           
        </h3>
    </div>
    <div class="col-sx-12 col-sm-offset-4 col-sm-8 col-md-7 col-lg-offset-0 col-lg-3">
        <h3 class="pull-right">
                <a class="btn btn-default" target="_blank" href="@Url.Action("Compare", "Plasmid")">
                    <i class="fa fa-bullseye text-danger"></i>
                    <span>Compare Plasmids</span>
                </a>
                <a class="btn btn-default" href="@Url.Action("Sequence", "Map", new { plasmid_id = plasmidId, tag = Tag})">
                    <i class="fa fa-exchange text-danger"></i>
                    <span>Sequence</span>
                </a>
                <a class="btn btn-default" href="@Url.Action("Enzyme", "Map", new { plasmid_id = plasmidId, tag = Tag})">
                    <i class="fa fa-scissors text-danger"></i>
                    <span>Enzymes</span>
                </a>
       </h3>
    </div>
</div>
<span id="decodeIt" class="hidden"></span>
<span id="seqCount" class="hidden">@seqCount</span>
<span id="name" class="hidden">@Name</span>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-8 col-lg-offset-1">
        <div class="col-xs-12 col-sm-offset-2 col-md-offset-3">
            @if (Tag != "groupDispaly")
            {
                if (Model.Count() > 0 && Model.FirstOrDefault().locked != 1)
                {
                    if (Sequence != null)
                    {
                        <div class="row">
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                                <a id="autogenerate" class="btn btn-link" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="autogenerate" })">
                                    <i class="fa fa-spinner text-danger"></i>
                                    <span>Auto</span>
                                </a>
                            </div>
                            @if (BackupCount > 0)
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a id="restore" class="btn btn-link" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="restore" })">
                                <i class="fa fa-undo text-danger"></i>
                                <span>Restore</span>
                            </a>
                        </div>
                        }
                        else
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link disabled" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="restore" })">
                                <i class="fa fa-undo text-muted"></i>
                                <span class="text-muted">Restore</span>
                            </a>
                        </div>
                        }

                            @if (Model.Count() > 0)
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a id="backup" class="btn btn-link" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="backup" })">
                                <i class="fa fa-copy text-danger"></i>
                                <span>Backup</span>
                            </a>
                        </div>
                        }
                        else
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link disabled" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="backup" })">
                                <i class="fa fa-copy text-muted"></i>
                                <span class="text-muted">Backup</span>
                            </a>
                        </div>
                        }
                        </div>
                        <div class="row">
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                                <a class="btn btn-link" href="@Url.Action("AddFeature", "Map", new { plasmid_id = plasmidId, tag="withseq" })">
                                    <i class="glyphicon glyphicon-plus text-danger"></i>
                                    <span class="">Add</span>
                                </a>
                            </div>
                            @if (Model.Count() > 0)
                        {
                            //allow only to change whether to show or not
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link" href="@Url.Action("Edit", "Map", new { plasmid_id = plasmidId })">
                                <i class="fa fa-pencil-square-o text-danger"></i>
                                <span>Edit</span>
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link" href="@Url.Action("Delete", "Map", new { plasmid_id = plasmidId })">
                                <i class="glyphicon glyphicon-trash text-danger"></i>
                                <span>Remove</span>
                            </a>
                        </div>
                        }
                        else
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link disabled" href="@Url.Action("Edit", "Map", new { plasmid_id = plasmidId })">
                                <i class="fa fa-pencil-square-o text-muted"></i>
                                <span class="text-muted">Edit</span>
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link" href="@Url.Action("Delete", "Map", new { plasmid_id = plasmidId })">
                                <i class="glyphicon glyphicon-trash text-muted"></i>
                                <span class="text-muted">Remove</span>
                            </a>
                        </div>
                        }
                        </div>
                    }
                    else
                    {
                        <div class="row">
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                                <a id="autogenerate" class="btn btn-link disabled" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="autogenerate" })">
                                    <i class="fa fa-spinner text-muted"></i>
                                    <span class="text-muted">Auto</span>
                                </a>
                            </div>
                            @if (BackupCount > 0)
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a id="restore" class="btn btn-link" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="restore" })">
                                <i class="fa fa-undo text-danger"></i>
                                <span>Restore</span>
                            </a>
                        </div>
                        }
                        else
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link disabled" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="restore" })">
                                <i class="fa fa-undo text-muted"></i>
                                <span class="text-muted">Restore</span>
                            </a>
                        </div>
                        }

                            @if (Model.Count() > 0)
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a id="backup" class="btn btn-link" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="backup" })">
                                <i class="fa fa-copy text-danger"></i>
                                <span>Backup</span>
                            </a>
                        </div>
                        }
                        else
                        {
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link disabled" href="@Url.Action("Index", "Map", new { id = plasmidId, tag="backup" })">
                                <i class="fa fa-copy text-muted"></i>
                                <span class="text-muted">Backup</span>
                            </a>
                        </div>
                        }
                        </div>
                        <div class="row">
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                                <a class="btn btn-link" href="@Url.Action("ChooseFeature", "Map", new { plasmid_id = plasmidId, tag="noseq" })">
                                    <i class="glyphicon glyphicon-plus text-danger"></i>
                                    <span>Add</span>
                                </a>
                            </div>

                            @if (Model.Count() > 0)
                        {
                            //allow to change everything except label and feature name
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link" href="@Url.Action("Change", "Map", new { plasmid_id = plasmidId })">
                                <i class="fa fa-pencil-square-o text-danger"></i>
                                <span>Edit</span>
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link" href="@Url.Action("Delete", "Map", new { plasmid_id = plasmidId })">
                                <i class="glyphicon glyphicon-trash text-danger"></i>
                                <span>Remove</span>
                            </a>
                        </div>
                        }
                        else
                        {
                            //allow to change everything except label and feature name
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link disabled" href="@Url.Action("Change", "Map", new { plasmid_id = plasmidId })">
                                <i class="fa fa-pencil-square-o text-muted"></i>
                                <span class="text-muted">Edit</span>
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
                            <a class="btn btn-link disabled" href="@Url.Action("Delete", "Map", new { plasmid_id = plasmidId })">
                                <i class="glyphicon glyphicon-trash text-muted"></i>
                                <span class="text-muted">Remove</span>
                            </a>
                        </div>
                        }

                        </div>
                    }
                }
            }
        </div>        
        <div class="col-xs-12 col-sm-10 col-sm-offset-2 col-md-offset-2 col-md-10 col-lg-offset-1" id="giraffe-map"></div>
    </div>
    <div class="col-xs-10 col-xs-offset-2 col-lg-offset-0 col-lg-3">
        <br/>
        <div class="plasmidDiv">
            <span class="text-danger">@Plasmid.name</span><br/>
            <span class="text-info"><strong>Expression: </strong></span><span>@Plasmid.expression_system</span>&nbsp;&nbsp;<span>@Plasmid.expression_subsystem</span><br />
            <span class="text-info"><strong>Insert/Gene: </strong></span>
            @if (Plasmid.insert != null)
            {
                <span>@Plasmid.insert</span><br />
                if (!string.IsNullOrWhiteSpace(Plasmid.insert_species))
                {
                    <span> (@Plasmid.insert_species)</span>
                }
                if (Plasmid.promotor != null)
                {
                    <span class="text-info"><strong>Promotor: </strong></span><span>@Plasmid.promotor</span><br />
                }
                if (Plasmid.polyA != null)
                {
                    <span class="text-info"><strong>PolyA: </strong></span><span>@Plasmid.polyA</span><br />
                }
            }
            else
            {
                <span>None</span><br />
            }
            <span class="text-info"><strong>Resistance: </strong></span><span>@Plasmid.resistance</span><br />
            @if (Plasmid.selection != null)
            {
                <span class="text-info"><strong>Selection: </strong></span><span>@Plasmid.selection</span><br />
            }
            @if (Plasmid.reporter != null)
            {
                <span class="text-info"><strong>Reporter: </strong></span><span>@Plasmid.reporter</span><br />
            }

            <span class="text-info"><strong>Experimental Use: </strong></span><span>@Plasmid.usage</span><br />
            @if (Plasmid.plasmid_type != null)
            {
                <span class="text-info"><strong>Plasmid Type: </strong></span><span>@Plasmid.plasmid_type</span><br />
            }

            @if (Plasmid.img_fn != null)
            {
                <span class="text-info"><strong>Linked File: </strong></span>
                <span>
                    <a href="@Url.Action("Download", "Plasmid", new { fileName=Plasmid.img_fn })">
                        <span style="color:black">@Plasmid.img_fn</span><i class="fa fa-download" style="font-size:80%; color:black;"></i>
                    </a>
                </span><br />
            }

            @if (Plasmid.ref_plasmid != null)
            {
                <span class="text-info"><strong>Linked Plasmid(s): </strong></span><span>@Plasmid.ref_plasmid</span><br />

            }
            @if (Plasmid.addgene != null)
            {
                <span class="text-info"><strong>Addgene#: </strong></span><span>@Plasmid.addgene</span><br />
            }
            <span class="text-info"><strong>Remarks: </strong></span><span>@Plasmid.des</span>
        </div>
    </div>
</div>

<div class="alert alert-success navbar-fixed-bottom" id="success-alert">
     <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
     <span>&nbsp;&nbsp;</span><span class="fa fa-info-circle"></span>&nbsp;Click the feature name to rotate the map.
</div>



@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/giraffe")
<script>
    $("#success-alert").fadeTo(20000, 500).slideUp(500, function () {
        $("#success-alert").alert('close');
    });
</script>

<script>

    //get plasmid feature json data
    var features = ("@features");
    document.getElementById("decodeIt").innerHTML = features;
    features = document.getElementById("decodeIt").textContent;

    //get full sequence
    seqCount = document.getElementById("seqCount").textContent;
    seqCount = parseInt(seqCount)
    //get plasmid name
    name = document.getElementById("name").textContent;
    try
    {
        features = JSON.parse(features);
        //console.log(features);
        data = [seqCount, features];
        //console.log(data);
        var gd = GiraffeDraw();
        gd.read(data);

        gd.CircularMap({
            'map_dom_id': 'giraffe-map',
            'plasmid_name': name,
            'map_width': 1044,
            'map_height': 648
            //'cutters': [1, 2, 3]
        })
    }
    catch(e)
    {
        console.error(e);
    }

</script>

<script>
    $('#autogenerate').click(function () {
        $('#autogenerate i').addClass("fa-pulse");
    });

    $('#backup').click(function () {
        $('#backup i').removeClass("fa-copy");
        $('#backup i').addClass("fa-spinner fa-pulse");
    });
    $('#restore').click(function () {
        $('#restore i').removeClass("fa-undo");
        $('#restore i').addClass("fa-spinner fa-pulse");
    });

    $('svg text tspan').on('click', redrawMap);


    function redrawMap(event) {
        var txt = $(event.target).text();
        //find feature clicked
        var oldStart = 0;
        $.each(data[1], function (index, d) {
            $.each(d, function (key, value) {
                if (value == txt) {
                    oldStart = d['start'];
                }
            });
        });
        //change the start and end
        $.each(data[1], function (i, dt) {
            if (dt['start'] >= oldStart) {
                dt['start'] = dt['start'] - oldStart + 1;
                dt['end'] = dt['end'] - oldStart + 1;
            }
            else {
                dt['start'] = seqCount - oldStart + dt['start'] + 1;
                if (dt['end'] >= oldStart) {
                    dt['end'] = dt['end'] - oldStart + 1;
                }
                else {
                    dt['end'] = seqCount - oldStart + dt['end'] + 1;
                }
            }
        });

        //reorder the data
        data[1].sort(sortByProperty('start'));
        //redraw the map
        gd.read(data);
        gd.CircularMap({
            'map_dom_id': 'giraffe-map',
            'plasmid_name': name,
            'map_width': 1044,
            'map_height': 648
        });

        //run the click-event again
        $('svg text tspan').on('click', redrawMap);
    };


    function sortByProperty(property) {
        'use strict';
        return function (a, b) {
            var sortStatus = 0;
            if (a[property] < b[property]) {
                sortStatus = -1;
            } else if (a[property] > b[property]) {
                sortStatus = 1;
            }
            return sortStatus;
        };
    }
</script>
